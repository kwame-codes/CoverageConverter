# Coverage Converter

.YML/YAML Example Usage

```
- task: VisualStudioTestPlatformInstaller@1
  inputs:
   packageFeedSelector: nugetOrg
   versionSelector: latestStable

- task: VSTest@2
  inputs:
    testSelector: testAssemblies
    testAssemblyVer2: |
      **\bin\**\*.Tests*.dll
      !**\obj\** 
      !**\bin\**\ref\**
      !**\bin\**\*Integration*.dll
    platform: '$(buildPlatform)'
    configuration: '$(buildConfiguration)'
    codeCoverageEnabled: true
    vsTestVersion: toolsInstaller
    testFiltercriteria: 'TestCategory!=Integration&TestCategory!=UI&TestCategory!=Chrome'

- task: CoverageConverterMod@0
  inputs:
    searchFolderForTestFiles: '$(System.DefaultWorkingDirectory)'
    #vsTestExeFileLocation: '$(Agent.HomeDirectory)\_work\_tool\VsTest\16.9.4\x64\tools\net451\Common7\IDE\Extensions\TestPlatform\vstest.console.exe'
    vsTestExeFileLocation: '$(Agent.HomeDirectory)\_work\_tool\VsTest\'
    vsTestArgs: '/EnableCodeCoverage'
    listTestFiles: |
      **\bin\**\*.Tests*.dll
      !**\obj\** 
      !**\bin\**\ref\**
      !**\bin\**\*Integration*.dll
    searchFolderForCodeCoverageFile: '$(System.DefaultWorkingDirectory)'
    temporaryFolderForCodeCoverage: 'Agent.TempDirectory'
    temporaryFileCoveragexml: '\TestResults\DynamicCodeCoverage.coveragexml'
    codeCoverageArgs: 'analyze /output:Coverage.xml'
    #codeCoverageExeFileLocation: '$(Agent.HomeDirectory)\_work\_tool\VsTest\16.9.4\x64\tools\net451\Team Tools\Dynamic Code Coverage Tools\CodeCoverage.exe'
    codeCoverageExeFileLocation: '$(Agent.HomeDirectory)\_work\_tool\VsTest\'
  ```  

Original https://github.com/Rogeriohsjr/CoverageConverter

This Task converts **.coverage** file into **.coveragexml** to be used with [Report Generator](https://marketplace.visualstudio.com/items?itemName=Palmmedia.reportgenerator).

## :smirk: Motivation/Points:
- I created this extension to help my pipeline process.
- Instead building a script which I would use only for me, I rather share the same code with everyone, so people don't need to waste their time searching for things that should be out of the box.
- Learning some new stuff like AzureDevOps Tasks and a bit of Node.

## :warning: Things to keep in mind
- We can't use Coverage.exe to generate .coverage file
    - [Thread about the topic](https://github.com/microsoft/vstest/issues/1502)

- :broken_heart: We can't use **VSTest@2** Task with **codeCoverageEnabled** as **true**
    - If we enabled it, this will add a file into [Code Coverage](https://marketplace.visualstudio.com/items?itemName=rogeriohsjr.build-release-task) tab in Azure DevOps, which will override the [Report Generator](https://marketplace.visualstudio.com/items?itemName=Palmmedia.reportgenerator) reports.
    - This is not because [Code Coverage](https://marketplace.visualstudio.com/items?itemName=rogeriohsjr.build-release-task), it is because [VSTest@2](https://github.com/microsoft/vstest) upload the coverage generated by itself to Azure Pipeline Tab Code Coverage automatically and we can't disable it. If they didn't upload the code coverage automatically we could use the coverage file generated by the [VSTest@2](https://github.com/microsoft/vstest). That is why the [Code Coverage](https://marketplace.visualstudio.com/items?itemName=rogeriohsjr.build-release-task) needs to execute again the [VSTest@2](https://github.com/microsoft/vstest).
    - [Here is Review Code Coverage Results Documentation from Microsoft](https://docs.microsoft.com/en-us/azure/devops/pipelines/test/review-code-coverage-results?view=azure-devops).
    - [Here is](https://github.com/MicrosoftDocs/azure-devops-docs/issues/6461#issuecomment-558358640) a thread that I asked to update the documentation to make it clear.
    - To be clear, we can use the [VSTest@2](https://github.com/microsoft/vstest) in our YML file, but we cannot use the Test Coverage from that task, the [Code Coverage](https://marketplace.visualstudio.com/items?itemName=rogeriohsjr.build-release-task) needs to be executed again, in order to get the coverage files.


## :triangular_ruler: How to setup this pipeline?

Basically we need to add these tasks in Azure DevOps.
1. Execute [Code Coverage(CoverageConverter@0)](https://marketplace.visualstudio.com/items?itemName=rogeriohsjr.build-release-task)
    1. This task will execute vsTest.exe which is the same used when we use VSTest@2 in azure DevOps.
    2. The result of vsTest.exe is the *.coverage files.
    3. The task will get all *.coverage file and covert into *.coveragexml, which is the format that Report Generator uses to generate a nice interface in Azure DevOps.
2. Execute [Report Generator(reportgenerator@4)](https://marketplace.visualstudio.com/items?itemName=Palmmedia.reportgenerator) to generate the Reports
    1. This task will get the ***.coveragexml*** that we generated and generate the reports into a folder.
3. Execute [Publish Code Coverage Results task(PublishCodeCoverageResults@1)](https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/test/publish-code-coverage-results?view=azure-devops)
    1. This Task will get the Report and publish into **Azure Code Coverage Tab**.

### Example of YML Files

[Azure Pipeline YML File - Example 1](https://github.com/Rogeriohsjr/TestWebApp/blob/master/azure-pipelines.yml)


## :gear: How does the convertion works?

Take a look in the code, I tried to comment the code to make that easier to understand. It is all in one file.

https://github.com/Rogeriohsjr/AzureDevOpsTask/blob/master/buildAndReleaseTask/index.ts
